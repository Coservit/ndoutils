###############################
# Makefile for NDO
#
# Last Modified: 09-27-2012
###############################


# Source code directories
SRC_BASE=./src
SRC_INCLUDE=./include
SRC_CONFIG=./config

prefix=@prefix@
exec_prefix=@exec_prefix@
LOGDIR=@localstatedir@
CFGDIR=@sysconfdir@
BINDIR=@bindir@
LIBEXECDIR=@libexecdir@
INSTALL=@INSTALL@
INSTALL_OPTS=@INSTALL_OPTS@
INIT_TYPE=@init_type@
INIT_DIR=@initdir@
INIT_OPTS=-o root -g root
INETD_TYPE=@inetd_type@
INETD_DIR=@inetddir@
INETD_FILE=@inetdname@
SRC_INETD=@src_inetd@
INIT_FILE=@initname@
SRC_INIT=@src_init@

all:
	cd $(SRC_BASE) && $(MAKE)

ctags:
	ctags -R

install:
	cd $(SRC_BASE) && $(MAKE) $@
	@echo ""
	@echo "Main NDOUtils components installed"
	@echo ""

install-config:
	$(INSTALL) -m 775 $(INSTALL_OPTS) -d $(DESTDIR)$(CFGDIR)
	$(INSTALL) -b -m 664 $(INSTALL_OPTS) config/ndo2db.cfg-sample $(DESTDIR)$(CFGDIR)
	$(INSTALL) -b -m 664 $(INSTALL_OPTS) config/ndomod.cfg-sample $(DESTDIR)$(CFGDIR)
	@echo ""
	@echo "*** Config files installed ***"
	@echo ""
	@echo "Remember, these are *SAMPLE* config files.  You'll need to rename"
	@echo "the files in order to use them."
	@echo "Please read the documentation to know what they are doing."
	@echo ""

install-init:
	@if test $(SRC_INIT) = unknown; then \
		echo No init file to install; \
		exit 1; \
	fi
	@if test $(INIT_TYPE) = upstart; then\
		echo $(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		echo initctl reload-configuration; \
		initctl reload-configuration; \
	elif test $(INIT_TYPE) = systemd; then\
		echo $(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
	elif test $(INIT_TYPE) = smf10 -o $(INIT_TYPE) = smf11; then \
		echo $(INSTALL) -m 775 -g sys -d $(INIT_DIR);\
		$(INSTALL) -m 775 -g sys -d $(INIT_DIR);\
		echo $(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 644 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		echo svccfg import $(INIT_DIR)/$(INIT_FILE); \
		svccfg import $(INIT_DIR)/$(INIT_FILE); \
		echo "*** Run 'svcadm enable ndo2db' to start it"; \
	else\
		echo $(INSTALL) -m 755 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		$(INSTALL) -m 755 startup/$(SRC_INIT) $(INIT_DIR)/$(INIT_FILE); \
		if test $(INIT_TYPE) = newbsd; then\
			if test $(DIST) = openbsd; then\
				echo "# ndo2db@bsd_enable@=NO" >> /etc/rc.conf;\
				echo "ndo2db@bsd_enable@=\"-d -c $(CFGDIR)/ndo2db.cfg\"" >> /etc/rc.conf;\
				echo "Make sure to enable the ndo2db daemon";\
			else\
				echo "ndo2db@bsd_enable@=YES" >> /etc/rc.conf;\
				echo "ndo2db_configfile=$(CFGDIR)/ndo2db.cfg" >> /etc/rc.conf;\
			fi;\
		elif test $(INIT_TYPE) = launchd; then\
			launchctl load $(INIT_DIR)/$(INIT_FILE); \
		else\
			if test -f /sbin/chkconfig ; then \
			    /sbin/chkconfig ndo2db on;\
			else\
				echo "Make sure to enable the ndo2db daemon";\
			fi;\
		fi;\
	fi

fullinstall: install install-init install-config

clean:
	cd $(SRC_BASE) && $(MAKE) $@
	rm -f core
	rm -f *~ */*~ include/nagios-*/*~

distclean: clean
	cd $(SRC_BASE) && $(MAKE) $@
	cd docs/docbook/en-en/ && $(MAKE) $@
	rm -f config.log config.status config.cache 
	rm -f $(SRC_INCLUDE)/dh.h $(SRC_INCLUDE)/config.h
	rm -f $(SRC_CONFIG)/ndo2db.cfg-sample $(SRC_CONFIG)/ndomod.cfg-sample $(SRC_CONFIG)/nagios.cfg $(SRC_CONFIG)/misccommands.cfg
	rm -f Makefile
	rm -f subst daemon-init
	rm -f tags

devclean: distclean

